name: CI for Infrastructure

on:
  pull_request:
    branches:
    - '*'

jobs:
    code-check:
      name: Terraform Validation and Build
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: Configure AWS Credentials Action For GitHub Actions
          uses: aws-actions/configure-aws-credentials@v2
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: us-west-1 
        - name: Setup Terraform CLI
          uses: hashicorp/setup-terraform@v2.0.2
    
        - name: Terraform init, plan and apply
        
          env:
            IS_PR: ${{ github.EVENT_NAME == 'pull_request' }}
          run: |
            echo `pwd`
            echo "tfpath ${{ github.event.inputs.tfpath }}"
            echo "** Running Terraform Init**"
            #terraform init
            
            echo "REF: ${{ github.GITHUB_HEAD_REF }}"
            echo "REF NAME: ${{ github.GITHUB_REF }}"
    
            # echo "** Running Terraform Validate**"
            # terraform validate
  
            # echo "** Running Terraform Plan**"
            # terraform plan
            
            BRANCH_NAME="${GITHUB_HEAD_REF}"

            echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV

        - name: "Another step uses branch name"
          run: echo "Branch name is ${{ env.BRANCH_NAME }}"
